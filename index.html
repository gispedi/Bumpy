
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BuMPy ‚Äì Fase 1: Cortesia + Invio</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f6fa; margin: 0; padding: 0; }
    .chat-container { max-width: 600px; margin: 30px auto; background: white; border-radius: 10px;
                      box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .header { background: #2a82e4; color: white; padding: 20px; border-radius: 10px 10px 0 0;
              text-align: center; }
    .messages { padding: 20px; height: 300px; overflow-y: auto; border-bottom: 1px solid #ccc; }
    .input-area { display: flex; flex-direction: column; gap: 10px; padding: 20px; }
    .input-area select, .input-area input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .input-area button { padding: 10px; background: #2a82e4; color: white; border: none;
                         border-radius: 5px; cursor: pointer; }
    .button-row { display: flex; justify-content: space-between; gap: 10px; }
    .message { margin-bottom: 10px; }
    .bot { color: #2a82e4; }
    .user { text-align: right; color: #333; }
  </style>
<link rel="manifest" href="manifest.json">
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <h2>BuMPy ‚Äì Il tuo assistente condominiale</h2>
    </div>
    <div class="messages" id="chat">
      <div class="message bot">Seleziona una categoria e parla o scrivi. BuMPy prender√† in carico la richiesta.</div>
    </div>
    <div class="input-area">
      <select id="category">
        <option value="guasto">üõ†Ô∏è Segnalazione guasti</option>
        <option value="documenti">üìë Richiesta documenti</option>
        <option value="amministrative">üí¨ Info amministrative</option>
        <option value="appuntamento">üóìÔ∏è Richiesta appuntamento</option>
      </select>
      <input type="text" id="userInput" placeholder="Scrivi o usa il microfono..." />
      <div class="button-row">
        <button onclick="startDictation()">üéôÔ∏è Parla</button>
        <button onclick="sendMessage()">Invia</button>
      </div>
      <div class="button-row">
        <button id="sendWhatsapp" style="flex:1; display:none;">üì≤ Invia via WhatsApp</button>
        <button id="sendEmail" style="flex:1; display:none;">üìß Invia via Email</button>
      </div>
    </div>
  </div>

  <script>
    const API_KEY = "AIzaSyBg21mrIO0NqKGQxSUKKywypy8s-JVLBJQ";

    const responsesByCategory = {
      guasto: "La ringraziamo per la segnalazione del guasto. Provvederemo a gestirla quanto prima.",
      documenti: "Grazie per la richiesta. Le forniremo i documenti richiesti al pi√π presto.",
      amministrative: "Abbiamo ricevuto la sua richiesta. Le risponderemo a breve con tutte le informazioni.",
      appuntamento: "Grazie per aver richiesto un appuntamento. La contatteremo per confermare data e ora."
    };

    function getResponse(category) {
      return responsesByCategory[category] || responsesByCategory["amministrative"];
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const category = document.getElementById('category').value;
      const chat = document.getElementById('chat');
      const userText = input.value.trim();
      if (!userText) return;

      const userMsg = document.createElement('div');
      userMsg.className = 'message user';
      userMsg.textContent = userText;
      chat.appendChild(userMsg);

      const replyText = getResponse(category);
      const botMsg = document.createElement('div');
      botMsg.className = 'message bot';
      botMsg.textContent = replyText;
      chat.appendChild(botMsg);

      chat.scrollTop = chat.scrollHeight;

      try {
        const response = await fetch('https://texttospeech.googleapis.com/v1/text:synthesize?key=' + API_KEY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            input: { text: replyText },
            voice: {
              languageCode: "it-IT",
              name: "it-IT-Chirp3-HD-Achernar"
            },
            audioConfig: {
              audioEncoding: "MP3"
            }
          })
        });

        const data = await response.json();
        const audioContent = data.audioContent;
        if (audioContent) {
          const audio = new Audio("data:audio/mp3;base64," + audioContent);
          await audio.play();
        }

        // mostra pulsanti invio
        document.getElementById("sendWhatsapp").style.display = "inline-block";
        document.getElementById("sendEmail").style.display = "inline-block";

        // prepara link WhatsApp ed Email
        const messageFull = `Categoria: ${category}\nMessaggio: ${userText}\nRisposta: ${replyText}`;
        document.getElementById("sendWhatsapp").onclick = () => {
          window.open("https://wa.me/?text=" + encodeURIComponent(messageFull), "_blank");
        };
        document.getElementById("sendEmail").onclick = () => {
          window.location.href = "mailto:amministratore@condominio.it?subject=Richiesta%20via%20BuMPy&body=" + encodeURIComponent(messageFull);
        };

      } catch (error) {
        console.error("Errore nella risposta vocale:", error);
      }

      input.value = '';
      chat.scrollTop = chat.scrollHeight;
    }

    function startDictation() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Il riconoscimento vocale non √® supportato su questo browser.");
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "it-IT";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('userInput').value = transcript;
        sendMessage();
      };
      recognition.onerror = function(event) {
        alert("Errore nel riconoscimento vocale: " + event.error);
      };
    }
  </script>
</body>
</html>
